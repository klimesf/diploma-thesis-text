\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

%!TEX ROOT=../diploma-thesis.tex

\chapter{Implementace prototypů knihoven}\label{ch:implementace}

\goal{Uvedení kapitoly a nastínění obsahu}
Součástí zadání této práce je implementace prototypů
knihoven pro framework navržený v kapitole~\ref{ch:navrh}
pro tři rozdílné platformy, z nichž jedna musí být \textit{Java}.
V této kapitole si popíšeme, jaké plaformy jsme vybraly, a jakým
způsobem byly prototypy knihoven implementovány. Součástí
kapitoly je i stručná rešerše technologií, které byly použity
pro dosažení vytyčených cílů.

\goal{Nástin formátu kapitoly}
Jelikož vycházejí implementace knihoven pro všechny platformy
ze stejného návrhu, popíšeme si kompletní implementaci pro jazyk
Java a ostatní implementace shrneme komparativní metodou.

\goal{Technické implementační problémy}
Pro splnění cílů bylo potřeba vyřešit také několik technických otázek,
jako je přenos byznys kontextů mezi jednotlivými službami, výběr formátu
pro zápis byznys kontextu, podpora aspektově orientovaného programování
v daném programovacím jazyce a využití principu \textit{runtime weavingu}
a integrace knihoven do služeb, které je budou využívat.

\section{Výběr použitých platforem}

\goal{Jaké jsme vybrali další platformy a proč}
Mimo jazyk Java, který byl určen zadáním, byla pro
implementaci vybrána platforma jazyka \textit{Python}
a platforma \textit{Node.js}, který slouží jako
běhové prostředí pro jazyk \textit{JavaScript}.
Výběr byl proveden na základě aktuálních trendů
ve světě softwarového inženýrství. Projekt GitHut\footnote{http://githut.info/}
z roku 2014, který shrnuje statistiky repozitářů
populární služby pro hosting a sdílení kódu
GitHub\footnote{https://github.com/}, určil
jazyky JavaScript, Java a Python jako tři nejaktivnější.
Služba GitHub následně sama zveřejnila statistiky za rok 2017
v rámci projektu Octoverse\footnote{https://octoverse.github.com/}
a dospěla ke stejnému závěru, ačkoliv Python se umístil na druhé
pozici na úkor jazyka Java. Podle průzkumu oblíbeného
programátorského webového portálu Stack
Overflow\footnote{https://insights.stackoverflow.com/survey/2017\#technology}
se umístily tyto jazyky v první čtveřici nejpopulárnějších jazyků pro obecné použití.

\section{Sdílení byznys kontextů mezi službami}

\goal{Jak na přenášení business contextů}
Pro sdílení byznys kontextů mezi jednotlivými službami
je potřeba je přenášet po síti ve formátu, který bude
nezávislý na platformách jednotlivých služeb.

\subsection{Síťová komunikace}

% Formát pro přenos pravidel po síti a jeho výhody
Abychom mohli přenášet byznysové kontexty a jejich pravidla
po síti, musíme zvolit protokol a jednotný formát, ve kterém
spolu budou jednotlivé služby komunikovat.
Tento formát tedy musí být nezávislý na platformě a ideálně
by měl být co nejefektivnější v rychlosti přenosu.

\subsubsection{Protocol Buffers}

\goal{Proč jsme použili Protobuf}
Pro přenos byznysových kontextů byl zvolen open-source formát
\textit{Protocol Buffers}\footnote{
https://developers.google.com/protocol-buffers/
}
vyvinutý společností Google\footnote{
https://www.google.com/
}. Umožňuje explicitně definovat a vynucovat schéma dat,
která jsou přenášena po síti, bez vazby na konkrétní programovací
jazyk. Zároveň je díky binární reprezentaci v přenosu velmi efektivní,
oproti formátům jako je JSON nebo XML~\cite{varda2008protocol}.
Zdrojový kód~\ref{lst:protobuf-example} znázorňuje zápis schématu
zasílaných zpráv ve formátu Protobuffer.

\lstinputlisting[caption={Příklad definice schématu zpráv v jazyce Protobuffer},label={lst:protobuf-example},language=Protobuf, frame=single, float, floatplacement=H]{code/protobuffer_example.proto}

\subsubsection{gRPC}

\goal{Proč jsme použili gRPC}
Pro komunikaci byznys kontextů nám nestačí pouze přenosový formát,
je potřeba také popsat schéma samotné komunikace. K tomu byl zvolen
open-source framework gRPC\footnote{
https://grpc.io/
}, který staví na technologii Protocol Buffers a poskytuje vývojáři
možnost definovat komunikaci pomocí protokolu \textit{RPC}~\cite{nelson1981remote}.

\lstinputlisting[caption={Příklad definice služeb v gRPC},label={lst:grpc-example},language=Protobuf, frame=single, float, floatplacement=H]{code/grpc_example.proto}

\todo{
\begin{itemize}
    \item Popis schématu pro komunikaci
    \item Diagram komunikace
\end{itemize}
}

\section{Knihovna pro platformu Java}

\todo{
\begin{itemize}
    \item Popis business context registry
    \item Popis expression AST
    \item Popis tříd kolem business kontextu
    \item Popis XML parseru a generátoru
    \item Popis server a klient tříd pro obsluhu GRPC
    \item Popis weaveru
    \item Popis anotací pro AOP
    \item Návrhové vzory - builder pro kontexty a pravidla
    \item Návrhové vzory - visitor pro převod expression do xml
    \item Návrhové vzory - interpreter pro interpretaci pravidel
\end{itemize}
}

\subsection{Použité technologie}

\subsubsection{Apache Maven}

\goal{Správa závislostí a buildu projektu}
Pro správu závislostí a automatickou kompilaci a sestavování
knihovny napsané v jazyce java byl zvolen projekt \textit{Maven}. %TODO: footnote
Tento nástroj umožňuje vývojáři komfortně a centrálně
spravovat závislosti jeho projektu včetně detailního
popisu jejich verze. Dále také umožňuje definovat jakým
způsobem bude projekt kompilován.

\subsubsection{AspectJ}

\goal{Proč AspectJ a co to umí}
Knihovna AspectJ přináší pro jazyk Java sadu nástrojů,
díky kterým lze snadno implementovat koncepty aspektově orientovaného
programování. % TODO: dopsat odstavec

\todo{
\begin{itemize}
    \item Ukázka kódu knihovny
\end{itemize}
}

\section{Knihovna pro platformu Python}

\todo{
\begin{itemize}
    \item Srovnání řešení s knihovnou Java
    \item Problémy pythonu a jak byly vyřešeny
    \item Ukázka kódu knihovny
    \item Použité technologie
    \item Ukázka AOP v pythonu pomocí vestavěných dekorátorů
    \item Knihovna pro GRPC
    \item Popis weaveru
\end{itemize}
}

\section{Knihovna pro platformu Node.js}

\todo{
\begin{itemize}
    \item Srovnání řešení s knihovnou Java
    \item Problémy JS a jak byly vyřešeny
    \item Ukázka kódu knihovny
    \item Ukázka AOP v JS pomocí vlastního dekorátoru
    \item Knihovna pro GRPC
    \item Popis weaveru
\end{itemize}
}

% TODO: fuj, opravit
\goal{Použité technologie pro vývoj knihovny}
Podobně jako byl použit nástroj Maven pro knihovnu v jazyce Java byl
využit balíčkovací nástroj \textit{NPM}, který je předinstalován
v běhovém prostředí \textit{Node.js}. Dále byl využit nástroj
\textit{Yarn}\footnote{http://yarnpkg.com} % TODO: opravit footnote

\section{Doménově specifický jazyk pro popis byznys kontextů}

\goal{Popsat proč a jak jsme tvořili DSL}
Ačkoliv není specifikace a vytvoření doménově specifického jazyka (DSL)
hlavním úkolem této práce, pro ověření konceptu bylo nutné nadefinovat
alespoň jeho zjednodušenou verzi a implementovat část knihovny, která
bude umět jazyk zpracovat a sestavit z něj byznysový kontext v paměti programu.

\goal{Důvody pro výběr XML}
Pro popis kontextů byl jako kompromis mezi jednoduchostí implementace
a přívětivostí pro koncového uživatele zvolen univerzální formát Extensible
Markup Language (XML)~\cite{bray1997extensible}. Tento
jazyk umožňuje serializaci libovolných dat, přímočarý a formální
zápis jejich struktury a také jejich snadné aplikační zpracování.
Zároveň poskytuje relativně dobrou čitelnost pro člověka, ačkoliv
speciálně vytvořené DSL by bylo jistě čitelnější.

\goal{Popis jak XML funguje}
Dokumenty XML se skládají z tzv. \textit{entit}, které obsahují
buď parsovaná nebo neparsovaná data. Parsovaná data se skládají
z jednoduchých znaků reprezentujících jednoduchý text a nebo
speciálních značek, neboli \textit{markup}, které slouží k popisu
struktury dat. Naopak neparsovaná data mohou obsahovat libovolné
znaky, které nenesou žádnou informaci o struktuře dat.

\goal{Popis jaký formát jsme zvolili pro formální zápis schématu XML dokumentu}
Vzhledem k tomu, že XML je volně rozšiřitelný jazyk a neklade
meze v možnostech struktury dat, bylo potřeba jasně definovat
a dokumentovat očekávanou strukturu dokumentu popisujícího
byznys kontext. Pro jazyk XML existuje vícero možností jak schéma
definovat~\cite{lee2000comparative}, od jednoduchého formátu
\textit{DTD} až po komplexní formáty jako je \textit{Schematron}, či
\textit{XML Schema Definition} (XSD), který byl nakonec zvolen.
Díky formálně definovanému schématu můžeme popis byznys kontextu
automaticky validovat a vyvarovat se tak případných chyb.

\goal{Popis formátu}
Ve zdrojovém kódu~\ref{lst:business-context-xml} můžeme vidět
příklad zápisu jednoduchého byznys kontextu s jednou precondition.
Samotný zápis byznys kontextu je obsažen v kořenovém elementu
\code{<businessContext>} a jeho název je popsán atributy
\code{prefix} a \code{name}. Rozšířené kontexty jsou vyčteny
v entitě \code{<includedContexts>}. Preconditions jsou
definovány uvnitř entity \code{<preconditions>} a podobně
jsou definovány \code{<postconditions>}. Obsažená data odpovídají
navrženému metamodelu byznysového kontextu z kapitoly~\ref{ch:navrh}. % TODO: ověřit že to v tý kapitole fakt mám, možná i odkaz na konkrétní odstavec
Pro zápis podmínek jednotlivých preconditions a post-conditions byl zvolen
opis Expression AST. Toto rozhodnutí vychází z předpokladu,
že lze vzhledem k povaze prototypu relaxovat podmínku
na čitelnost zápisu pravidel ve prospěch jednoduššího zpracování.

\goal{Shrnutí DSL}
Podařilo se nám navrhnout přijatelný formát zápisu byznys kontextu
a implementovat části knihoven, které umějí formát číst a zároveň vytvářet.
Tím jsme dosáhli možnosti zapisovat kontexty bez ohledu na platformu
služby, která je bude využívat. Zároveň tomuto formátu mohou
snáze porozumět doménoví experti a mohou se tak zapojit do
vývojového procesu.

\lstinputlisting[caption={Příklad zápisu byznys kontextu v jazyce XML},label={lst:business-context-xml}, language=XML, frame=single, float, floatplacement=H]{code/business_context.xml}

\section{Systém pro centrální správu byznys pravidel}

\todo{
\begin{itemize}
    \item Jak funguje systém
    \item Přehled, detail a úprava pravidla
    \item \code{BusinessContextEditor}
    \item Uložení pravidla
\end{itemize}
}

\subsection{Použité technologie}

\todo{
\begin{itemize}
    \item Uživatelské rozhraní v HTML + CSS
    \item Jak jsme použili Spring Boot a jeho MVC k nastavení základní webové aplikace
    \item Dependency Injection Container
    \item Využití knihovny pro platformu Java
\end{itemize}
}

\subsection{Detekce a prevence potenciálních problémů}

\goal{Problémy zpsůbené rozšiřováním kontextů}
Při úpravě nebo vytváření nového byznysového kontextu je
potřeba detekovat případné chyby, abychom změnou neuvedli
systém do nekonzistentního stavu. Kromě syntaktických chyb,
které jsou detekovány automaticky pomocí definovaného schematu,
je potřeba věnovat pozornost také sémantickým chybám.
Závažné chyby, které mohou být způsobeny rozšiřováním kontextů, jsou
\begin{enumerate}[label=\alph*)]
    \item Závislosti na neexistujících kontextech
    \item Cyklus v grafu závislostí kontextů
\end{enumerate}

\goal{Chápání kontextů jako grafu}
Kontexty a jejich vzájemné závislosti lze vnímat jako
orientovaný graf, kde uzel grafu reprezentuje kontext
a orientovaná hrana reprezentuje závislost mezi kontexty.
Směr závislosti můžeme pro naše účely zvolit libovolně.

\goal{Detekce závislostí na neexistujících kontextech}
Detekce závislosti na neexistujících kontextech je relativně
jednoduchým úkolem. Nejprve setavíme seznam existujících kontextů
a následně procházíme jednotlivé hrany grafu kontextů a ověřujeme,
zda existují oba kontexty náležící dané hraně.
Při zvolení vhodných datových struktur lze dosáhnout
lineární složitosti v závislosti na počtu hran grafu.

\goal{Detekce cyklů v grafu závislostí}
Pokud by závislosti v orientovaném grafu vytvořily cyklus,
docházelo by při inicializaci služeb
obsahující daná pravidla k zacyklení. Tomu můžeme předejít
detekcí cyklů v grafu. Pro tuto detekci byl zvolen
Tarjanův algoritmus~\cite{tarjan1971depth} pro detekci souvislých
komponent, který disponuje velmi dobrou lineární složitostí,
závislou na součtu počtu hran a počtu uzlů grafu.

\goal{Reakce na chyby}
V případě, že zápis nového či praveného kontextu obsahuje syntaktické
chyby a nebo způsobuje některou z detekovaných chyb v závislostech,
administrace nedovolí uživateli změnu provést a vypíše informativní
chybovou hlášku.

\section{Shrnutí}

\goal{Dosáhli jsme vytyčených cílů implementace}
Na základě navrženého frameworku jsme implementovali prototypy
knihoven pro platformy jazyka Java, jazyka Python a ekosystému
Node.js. Knihovny umožňují centrální správu a automatickou distribuci
byznysových kontextů, včetně vyhodnocování jejich pravidel, za
použití aspektově orientovaného přístupu.
Dále jsme specifikovali DSL, kterým lze popsat byznys kontext
nezávisle na platformě.

\goal{Hostování na GitHubu + licence}
Veškerý kód je hostován v centrálním repozitáři
ve službě GitHub\footnote{
https://github.com/klimesf/diploma-thesis
} a je zpřístupněn pod open-source licencí MIT\footnote{
http://www.linfo.org/mitlicense.html
}. Knihovny pro jednotlivé platformy tedy lze libovolně
využívat, modifikovat a šířit.

\goal{Validaci a verifikaci si ještě ukážeme}
Protoypy knihoven lze využít k implementaci služeb,
potažmo k sestavení funkčního systému, jak si ukážeme
v následující kapitole.
